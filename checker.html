<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>ç°¡æ˜“ãƒ¬ã‚¸ï¼ˆå°è¨ˆï¼‰</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="robots" content="noindex,nofollow" />
  <style>
    :root{
      --bg:#f5f6f8;
      --panel:#ffffff;
      --fg:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --accent:#2563eb;
      --danger:#dc2626;
      --warn:#b45309;
      --ok:#059669;
      --shadow: 0 8px 24px rgba(0,0,0,.08);
      --radius:14px;
    }
    *{ box-sizing:border-box; }
    html,body{ margin:0; padding:0; color:var(--fg); background:var(--bg); font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif; }
    a{ color:inherit; }
    button, input, select{ font:inherit; }
    .wrap{ max-width:1100px; margin:0 auto; padding:14px; }
    .header{
      position: sticky;
      top: 0;
      z-index: 5;
      background: rgba(245,246,248,.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
    }
    .header-inner{
      max-width:1100px;
      margin:0 auto;
      padding:10px 14px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
    }
    .title{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width: 200px;
    }
    .title h1{
      font-size:16px;
      line-height:1.2;
      margin:0;
      font-weight:700;
    }
    .meta{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--border);
      background: var(--panel);
      border-radius:999px;
      padding:8px 10px;
      font-size:12px;
      box-shadow: 0 1px 0 rgba(0,0,0,.02);
      white-space:nowrap;
    }
    .dot{ width:10px; height:10px; border-radius:50%; background: var(--muted); display:inline-block; }
    .dot.ok{ background: var(--ok); }
    .dot.ng{ background: var(--danger); }

    .grid{
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:14px;
      margin-top:14px;
    }
    .card{
      background: var(--panel);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-h{
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .card-h h2{
      margin:0;
      font-size:14px;
      font-weight:700;
    }
    .card-b{
      padding:14px;
    }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      flex:1;
      min-width: 220px;
    }
    .label{
      font-size:12px;
      color:var(--muted);
    }
    select, input[type="text"], input[type="number"], input[type="date"]{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      outline:none;
    }
    input:focus, select:focus{ border-color: rgba(37,99,235,.5); box-shadow: 0 0 0 4px rgba(37,99,235,.12); }

    .btn{
      border:1px solid var(--border);
      background:#fff;
      padding:12px 12px;
      border-radius:12px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      min-height:44px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:hover{ border-color:#d1d5db; }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: var(--accent);
      color:#fff;
      border-color: rgba(0,0,0,0);
    }
    .btn.primary:hover{ filter:brightness(.98); }
    .btn.danger{
      background: var(--danger);
      color:#fff;
      border-color: rgba(0,0,0,0);
    }
    .btn.ghost{
      background: transparent;
    }
    .btn.small{
      padding:10px 10px;
      min-height:40px;
      border-radius:10px;
      font-size:13px;
    }
    .btn.icon{
      width:44px;
      padding:0;
    }
    .btn[disabled]{
      opacity:.5;
      cursor:not-allowed;
      transform:none;
    }

    .notice{
      border-radius:12px;
      padding:10px 12px;
      border:1px solid var(--border);
      background:#fafafa;
      font-size:13px;
      color:var(--muted);
    }
    .notice.err{
      border-color: rgba(220,38,38,.25);
      background: rgba(220,38,38,.08);
      color: #7f1d1d;
    }
    .notice.warn{
      border-color: rgba(180,83,9,.25);
      background: rgba(180,83,9,.10);
      color: #7c2d12;
    }
    .notice.ok{
      border-color: rgba(5,150,105,.25);
      background: rgba(5,150,105,.10);
      color: #064e3b;
    }

    /* Items table */
    .table-wrap{ overflow:auto; }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width: 680px;
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid var(--border);
      vertical-align:middle;
      font-size:13px;
    }
    th{
      text-align:left;
      color:var(--muted);
      font-weight:600;
      background:#fafafa;
      position:sticky;
      top:0;
      z-index:1;
    }
    tr:last-child td{ border-bottom:none; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .right{ text-align:right; }
    .muted{ color:var(--muted); }

    .qty{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      min-width: 170px;
    }
    .qty input{
      width: 72px;
      text-align:center;
      padding:10px 8px;
      border-radius:10px;
    }

    .summary{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .sum-block{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      background:#fff;
    }
    .sum-title{
      font-weight:700;
      font-size:13px;
      margin-bottom:8px;
    }
    .sum-row{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:4px 0;
      font-size:13px;
    }
    .sum-row strong{ font-size:14px; }
    .divider{
      height:1px;
      background: var(--border);
      margin:8px 0;
    }

    .sticky-actions{
      position: sticky;
      bottom: 0;
      background: rgba(255,255,255,.85);
      backdrop-filter: blur(10px);
      border-top:1px solid var(--border);
      padding:10px 14px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .sticky-actions .left, .sticky-actions .right{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    /* Responsive */
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      table{ min-width: 760px; }
    }
    @media (max-width: 520px){
      .header-inner{ flex-direction:column; align-items:flex-start; }
      .meta{ justify-content:flex-start; }
      .field{ min-width: 100%; }
      .sticky-actions{ flex-direction:column; align-items:stretch; }
      .sticky-actions .left, .sticky-actions .right{ width:100%; justify-content:space-between; }
      .btn{ width:100%; }
      .btn.icon{ width:44px; }
    }
  </style>
</head>

<body>
  <div class="header">
    <div class="header-inner">
      <div class="title">
        <h1>ç°¡æ˜“ãƒ¬ã‚¸ï¼ˆå°è¨ˆï¼‰</h1>
        <div class="muted" style="font-size:12px;">JST: <span id="nowJst" class="mono">----</span></div>
      </div>
      <div class="meta">
        <div class="pill" title="ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ…‹">
          <span id="netDot" class="dot"></span>
          <span id="netText">--</span>
        </div>
        <div class="pill" title="å°è¨ˆçŠ¶æ…‹">
          <span id="calcState" class="muted">å°è¨ˆæœªå®Ÿè¡Œ</span>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- LEFT: Main -->
      <div class="card">
        <div class="card-h">
          <h2>ã‚¹ã‚­ãƒ£ãƒ³ãƒ»æ˜ç´°</h2>
          <button class="btn ghost small" id="btnClear" type="button">ä¼šè¨ˆã‚’ã‚¯ãƒªã‚¢</button>
        </div>

        <div class="card-b">
          <div class="row" style="margin-bottom:12px;">
            <div class="field" style="max-width:360px;">
              <div class="label">ãƒ¬ã‚¸æ‹…å½“è€…ï¼ˆå¿…é ˆï¼‰</div>
              <select id="cashierName">
                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                <option>å±±ç”°</option>
                <option>ä½è—¤</option>
                <option>éˆ´æœ¨</option>
              </select>
            </div>

            <div class="field">
              <div class="label">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰å…¥åŠ›ï¼ˆã‚¹ã‚­ãƒ£ãƒŠã®Enterã§è¿½åŠ ï¼‰</div>
              <input id="scanInput" type="text" inputmode="numeric" autocomplete="off" placeholder="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„ï¼ˆæ•°å­—1ã€œ13æ¡ï¼‰" />
            </div>

            <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;">
              <button class="btn small" type="button" id="btnAddManual">æ‰‹å…¥åŠ›ã§è¿½åŠ </button>
              <button class="btn small" type="button" id="btnFocus">å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹</button>
            </div>
          </div>

          <div id="noticeArea" class="notice" style="margin-bottom:12px;">
            ã‚¹ã‚­ãƒ£ãƒ³æ¬„ã¯å¸¸ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã—ã¦ä½¿ã£ã¦ãã ã•ã„ã€‚å•†å“ãƒã‚¹ã‚¿æœªç™»éŒ²ã¯ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚
          </div>

          <div class="row" style="margin-bottom:10px;">
            <div class="notice" style="flex:1;">
              æœ€å¾Œã«è¿½åŠ ï¼š<span id="lastAdded" class="muted">---</span>
            </div>
          </div>

          <div class="table-wrap card" style="box-shadow:none; border-radius:12px; border:1px solid var(--border);">
            <table>
              <thead>
                <tr>
                  <th style="width:34%;">å•†å“</th>
                  <th style="width:8%;">ç¨ç‡</th>
                  <th class="right" style="width:12%;">ç¨æŠœå˜ä¾¡</th>
                  <th style="width:20%; text-align:center;">æ•°é‡</th>
                  <th class="right" style="width:12%;">ç¨æŠœé‡‘é¡</th>
                  <th style="width:8%; text-align:center;">å‰Šé™¤</th>
                </tr>
              </thead>
              <tbody id="itemsTbody">
                <!-- rows -->
              </tbody>
            </table>
          </div>

          <div style="margin-top:12px;" class="notice warn" id="staleNotice" hidden>
            æ˜ç´°ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚å°è¨ˆã¯æœªæ›´æ–°ã§ã™ï¼ˆå°è¨ˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ï¼‰ã€‚
          </div>
        </div>

        <div class="sticky-actions">
          <div class="left">
            <button class="btn primary" id="btnSubtotal" type="button">å°è¨ˆï¼ˆç¨ç‡åˆ¥ï¼‰</button>
          </div>
          <div class="right">
            <span class="muted" style="font-size:12px;">â€»ç¨é¡ã¯ã€Œç¨ç‡åˆ¥ç¨æŠœå°è¨ˆã€Ã—ç¨ç‡ ã‚’å°æ•°ç‚¹åˆ‡ã‚Šä¸Šã’</span>
          </div>
        </div>
      </div>

      <!-- RIGHT: Summary + Register -->
      <div class="card">
        <div class="card-h">
          <h2>å°è¨ˆãƒ»ç™»éŒ²</h2>
        </div>

        <div class="card-b">
          <div class="summary" style="margin-bottom:14px;">
            <div class="sum-block">
              <div class="sum-title">10% å¯¾è±¡</div>
              <div class="sum-row"><span class="muted">ç¨æŠœå°è¨ˆ</span><span class="mono" id="excl10">0</span></div>
              <div class="sum-row"><span class="muted">ç¨é¡ï¼ˆåˆ‡ä¸Šã’ï¼‰</span><span class="mono" id="tax10">0</span></div>
              <div class="divider"></div>
              <div class="sum-row"><strong>ç¨è¾¼å°è¨ˆ</strong><strong class="mono" id="incl10">0</strong></div>
            </div>

            <div class="sum-block">
              <div class="sum-title">8% å¯¾è±¡</div>
              <div class="sum-row"><span class="muted">ç¨æŠœå°è¨ˆ</span><span class="mono" id="excl8">0</span></div>
              <div class="sum-row"><span class="muted">ç¨é¡ï¼ˆåˆ‡ä¸Šã’ï¼‰</span><span class="mono" id="tax8">0</span></div>
              <div class="divider"></div>
              <div class="sum-row"><strong>ç¨è¾¼å°è¨ˆ</strong><strong class="mono" id="incl8">0</strong></div>
            </div>

            <div class="sum-block" style="border-color: rgba(37,99,235,.25); background: rgba(37,99,235,.06);">
              <div class="sum-row"><strong>åˆè¨ˆï¼ˆç¨è¾¼ï¼‰</strong><strong class="mono" id="totalIncl">0</strong></div>
            </div>
          </div>

          <div class="field" style="margin-bottom:10px;">
            <div class="label">ãƒ¬ã‚·ãƒ¼ãƒˆç•ªå·ï¼ˆå¿…é ˆï¼‰</div>
            <input id="receiptNo" type="text" autocomplete="off" placeholder="æ±ºæ¸ˆãƒ¬ã‚·ãƒ¼ãƒˆç•ªå·ã‚’å…¥åŠ›" />
          </div>

          <div class="notice" style="margin-bottom:10px;">
            transaction_idï¼š<span class="mono" id="txId">----</span>
          </div>

          <div class="row" style="margin-bottom:10px;">
            <button class="btn primary" id="btnRegister" type="button" style="flex:1;">ç™»éŒ²</button>
            <button class="btn" id="btnDownloadCsv" type="button" style="flex:1;" hidden>CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
          </div>

          <div class="notice" id="regNotice">
            ç™»éŒ²ã«æˆåŠŸã™ã‚‹ã¨ã€æ˜ç´°ãŒã‚¯ãƒªã‚¢ã•ã‚Œæ¬¡ã®ä¼šè¨ˆã«é€²ã¿ã¾ã™ã€‚é€ä¿¡å¤±æ•—æ™‚ã¯CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // Demoå•†å“ãƒã‚¹ã‚¿ï¼ˆUIç¢ºèªç”¨ï¼‰
    // å®Ÿé‹ç”¨ã§ã¯APIã§å‚ç…§ã«ç½®ãæ›ãˆã‚‹æƒ³å®š
    // =========================
    const DEMO_PRODUCT_MASTER = {
      "4901234567890": { product_code:"4901234567890", product_name:"å•†å“A", dept_name:"é£Ÿå“", cost_unit:60, unit_price_excl:100, tax_rate:10 },
      "4901234567001": { product_code:"4901234567001", product_name:"å•†å“B", dept_name:"é£²æ–™", cost_unit:50, unit_price_excl:101, tax_rate:8 },
      "1234567":        { product_code:"1234567",        product_name:"çŸ­ã„ã‚³ãƒ¼ãƒ‰å•†å“", dept_name:"é›‘è²¨", cost_unit:30, unit_price_excl:200, tax_rate:10 }
    };

    // =========================
    // State
    // =========================
    const state = {
      itemsByCode: new Map(), // product_code => { ...product, qty, line_amount_excl, line_cost_amount }
      lastAddedText: "---",
      subtotal: {
        excl8: 0, tax8: 0, incl8: 0,
        excl10: 0, tax10: 0, incl10: 0,
        totalIncl: 0
      },
      subtotalFresh: false,
      lastSubtotalAtJst: null
    };

    // =========================
    // Elements
    // =========================
    const elNowJst = document.getElementById("nowJst");
    const elNetDot = document.getElementById("netDot");
    const elNetText = document.getElementById("netText");
    const elCalcState = document.getElementById("calcState");

    const elCashierName = document.getElementById("cashierName");
    const elScanInput = document.getElementById("scanInput");
    const elBtnAddManual = document.getElementById("btnAddManual");
    const elBtnFocus = document.getElementById("btnFocus");
    const elNoticeArea = document.getElementById("noticeArea");
    const elLastAdded = document.getElementById("lastAdded");
    const elItemsTbody = document.getElementById("itemsTbody");
    const elStaleNotice = document.getElementById("staleNotice");

    const elExcl10 = document.getElementById("excl10");
    const elTax10 = document.getElementById("tax10");
    const elIncl10 = document.getElementById("incl10");
    const elExcl8 = document.getElementById("excl8");
    const elTax8 = document.getElementById("tax8");
    const elIncl8 = document.getElementById("incl8");
    const elTotalIncl = document.getElementById("totalIncl");

    const elReceiptNo = document.getElementById("receiptNo");
    const elTxId = document.getElementById("txId");
    const elBtnSubtotal = document.getElementById("btnSubtotal");
    const elBtnRegister = document.getElementById("btnRegister");
    const elBtnClear = document.getElementById("btnClear");
    const elBtnDownloadCsv = document.getElementById("btnDownloadCsv");
    const elRegNotice = document.getElementById("regNotice");

    // =========================
    // JST utils (local timezoneã«ä¾å­˜ã›ãš +09:00 å›ºå®š)
    // =========================
    function pad2(n){ return String(n).padStart(2,"0"); }
    function getNowJstDate(){
      const now = new Date();
      const utcMs = now.getTime() + (now.getTimezoneOffset() * 60000);
      const jstMs = utcMs + (9 * 60 * 60000);
      return new Date(jstMs);
    }
    function formatJstDateTime(dt){
      const y = dt.getUTCFullYear();
      const m = pad2(dt.getUTCMonth() + 1);
      const d = pad2(dt.getUTCDate());
      const hh = pad2(dt.getUTCHours());
      const mm = pad2(dt.getUTCMinutes());
      const ss = pad2(dt.getUTCSeconds());
      return `${y}-${m}-${d} ${hh}:${mm}:${ss}`;
    }
    function yyyymmddFromJst(dt){
      const y = dt.getUTCFullYear();
      const m = pad2(dt.getUTCMonth() + 1);
      const d = pad2(dt.getUTCDate());
      return `${y}${m}${d}`;
    }

    // =========================
    // UI helpers
    // =========================
    function setNotice(type, text){
      elNoticeArea.className = "notice" + (type ? ` ${type}` : "");
      elNoticeArea.textContent = text;
    }
    function setRegNotice(type, text){
      elRegNotice.className = "notice" + (type ? ` ${type}` : "");
      elRegNotice.textContent = text;
    }
    function money(n){ return (n ?? 0).toLocaleString("ja-JP"); }

    function markSubtotalStale(){
      state.subtotalFresh = false;
      elStaleNotice.hidden = false;
      elCalcState.textContent = "å°è¨ˆæœªæ›´æ–°";
    }

    function markSubtotalFresh(){
      state.subtotalFresh = true;
      elStaleNotice.hidden = true;
      elCalcState.textContent = "å°è¨ˆOK";
    }

    function updateNetworkBadge(){
      const online = navigator.onLine;
      elNetDot.classList.toggle("ok", online);
      elNetDot.classList.toggle("ng", !online);
      elNetText.textContent = online ? "ã‚ªãƒ³ãƒ©ã‚¤ãƒ³" : "ã‚ªãƒ•ãƒ©ã‚¤ãƒ³";
    }

    function sanitizeReceiptForTx(receiptNo){
      return String(receiptNo || "").trim().replace(/[^A-Za-z0-9_-]/g, "_");
    }

    function updateTxIdPreview(){
      const r = sanitizeReceiptForTx(elReceiptNo.value);
      if (!r) {
        elTxId.textContent = "----";
        return;
      }
      const dt = getNowJstDate();
      const ymd = yyyymmddFromJst(dt);
      elTxId.textContent = `${ymd}_${r}`;
    }

    // =========================
    // Product lookup (demo)
    // =========================
    async function fetchProductByCode(code){
      // TODO: å®Ÿé‹ç”¨ã§ã¯APIã¸ç½®æ›
      // return await (await fetch(`/api/products?code=${encodeURIComponent(code)}`)).json()
      const p = DEMO_PRODUCT_MASTER[code];
      if (!p) return null;
      return JSON.parse(JSON.stringify(p));
    }

    // =========================
    // Items
    // =========================
    function upsertItem(product){
      const code = product.product_code;
      const existing = state.itemsByCode.get(code);

      if (existing){
        existing.qty += 1;
        existing.line_amount_excl = existing.unit_price_excl * existing.qty;
        if (existing.cost_unit != null){
          existing.line_cost_amount = existing.cost_unit * existing.qty;
        }
        state.lastAddedText = `${existing.product_name}ï¼ˆæ•°é‡ ${existing.qty}ï¼‰`;
      } else {
        const qty = 1;
        const it = {
          product_code: product.product_code,
          product_name: product.product_name,
          dept_name: product.dept_name || "",
          tax_rate: Number(product.tax_rate) === 8 ? 8 : 10,
          unit_price_excl: Number(product.unit_price_excl) | 0,
          qty: qty,
          line_amount_excl: (Number(product.unit_price_excl) | 0) * qty,
          cost_unit: product.cost_unit == null ? null : (Number(product.cost_unit) | 0),
          line_cost_amount: product.cost_unit == null ? null : ((Number(product.cost_unit) | 0) * qty)
        };
        state.itemsByCode.set(code, it);
        state.lastAddedText = `${it.product_name}ï¼ˆæ•°é‡ 1ï¼‰`;
      }

      elLastAdded.textContent = state.lastAddedText;
      renderItems();
      markSubtotalStale();
    }

    function setQty(code, qty){
      const it = state.itemsByCode.get(code);
      if (!it) return;
      const q = Math.max(1, qty | 0);
      it.qty = q;
      it.line_amount_excl = it.unit_price_excl * it.qty;
      if (it.cost_unit != null){
        it.line_cost_amount = it.cost_unit * it.qty;
      }
      state.lastAddedText = `${it.product_name}ï¼ˆæ•°é‡ ${it.qty}ï¼‰`;
      elLastAdded.textContent = state.lastAddedText;
      renderItems();
      markSubtotalStale();
    }

    function incQty(code){ setQty(code, (state.itemsByCode.get(code)?.qty || 1) + 1); }
    function decQty(code){ setQty(code, (state.itemsByCode.get(code)?.qty || 1) - 1); }

    function removeItem(code){
      const it = state.itemsByCode.get(code);
      if (!it) return;
      state.itemsByCode.delete(code);
      state.lastAddedText = `${it.product_name} ã‚’å‰Šé™¤`;
      elLastAdded.textContent = state.lastAddedText;
      renderItems();
      markSubtotalStale();
    }

    function renderItems(){
      const items = Array.from(state.itemsByCode.values());

      if (items.length === 0){
        elItemsTbody.innerHTML = `
          <tr>
            <td colspan="6" class="muted" style="padding:14px;">
              ã¾ã å•†å“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„ã€‚
            </td>
          </tr>
        `;
        return;
      }

      elItemsTbody.innerHTML = items.map(it => {
        const taxLabel = it.tax_rate === 8 ? "8%" : "10%";
        return `
          <tr data-code="${it.product_code}">
            <td>
              <div style="display:flex; flex-direction:column; gap:2px;">
                <div style="font-weight:700;">${escapeHtml(it.product_name)}</div>
                <div class="muted mono" style="font-size:12px;">${escapeHtml(it.product_code)}</div>
              </div>
            </td>
            <td class="mono">${taxLabel}</td>
            <td class="right mono">${money(it.unit_price_excl)}</td>
            <td>
              <div class="qty">
                <button class="btn small icon" type="button" data-act="dec" title="æ•°é‡ã‚’æ¸›ã‚‰ã™">âˆ’</button>
                <input class="mono" type="number" min="1" step="1" inputmode="numeric" data-act="qty" value="${it.qty}">
                <button class="btn small icon" type="button" data-act="inc" title="æ•°é‡ã‚’å¢—ã‚„ã™">ï¼‹</button>
              </div>
            </td>
            <td class="right mono">${money(it.line_amount_excl)}</td>
            <td style="text-align:center;">
              <button class="btn small danger" type="button" data-act="del" title="å‰Šé™¤">ğŸ—‘</button>
            </td>
          </tr>
        `;
      }).join("");

      // bind row events (delegation)
      elItemsTbody.querySelectorAll("tr").forEach(tr => {
        const code = tr.getAttribute("data-code");

        tr.querySelector('[data-act="inc"]').addEventListener("click", () => { incQty(code); keepFocus(); });
        tr.querySelector('[data-act="dec"]').addEventListener("click", () => { decQty(code); keepFocus(); });
        tr.querySelector('[data-act="del"]').addEventListener("click", () => { removeItem(code); keepFocus(); });

        const qtyInput = tr.querySelector('[data-act="qty"]');
        qtyInput.addEventListener("change", () => {
          const v = Number(qtyInput.value);
          setQty(code, Number.isFinite(v) ? v : 1);
          keepFocus();
        });
        qtyInput.addEventListener("focus", () => {
          // iPadã§æ•°å­—å…¥åŠ›ãŒã—ã‚„ã™ã„ã‚ˆã†ã«å…¨é¸æŠ
          try{ qtyInput.select(); }catch(e){}
        });
      });
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, (c) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    // =========================
    // Subtotal (tax summary)
    // ç¨é¡: ç¨ç‡åˆ¥ç¨æŠœå°è¨ˆ Ã— ç¨ç‡ ã‚’å°æ•°ç‚¹åˆ‡ã‚Šä¸Šã’
    // =========================
    function calcTaxCeil(subtotalExcl, taxRate){
      // ceil(subtotalExcl * taxRate / 100)
      return Math.ceil((subtotalExcl * taxRate) / 100);
    }

    function runSubtotal(){
      const items = Array.from(state.itemsByCode.values());
      if (items.length === 0){
        setNotice("warn", "å•†å“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      const excl8 = items.filter(i => i.tax_rate === 8).reduce((a,b)=>a+b.line_amount_excl, 0);
      const excl10 = items.filter(i => i.tax_rate === 10).reduce((a,b)=>a+b.line_amount_excl, 0);

      const tax8 = calcTaxCeil(excl8, 8);
      const tax10 = calcTaxCeil(excl10, 10);

      const incl8 = excl8 + tax8;
      const incl10 = excl10 + tax10;
      const totalIncl = incl8 + incl10;

      state.subtotal = { excl8, tax8, incl8, excl10, tax10, incl10, totalIncl };
      state.lastSubtotalAtJst = formatJstDateTime(getNowJstDate());

      elExcl8.textContent = money(excl8);
      elTax8.textContent = money(tax8);
      elIncl8.textContent = money(incl8);
      elExcl10.textContent = money(excl10);
      elTax10.textContent = money(tax10);
      elIncl10.textContent = money(incl10);
      elTotalIncl.textContent = money(totalIncl);

      markSubtotalFresh();
      setNotice("ok", "å°è¨ˆã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚å†…å®¹ãŒæ­£ã—ã‘ã‚Œã°æ±ºæ¸ˆç«¯æœ«ã§ä¼šè¨ˆã—ã€ãƒ¬ã‚·ãƒ¼ãƒˆç•ªå·ã‚’å…¥åŠ›ã—ã¦ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚");
    }

    // =========================
    // CSV
    // record_type: ITEM / TAX_SUMMARY
    // å…¨è¡Œã« registered_at_jst, receipt_no, transaction_id ã‚’ä»˜ä¸
    // =========================
    function buildCsvText(registeredAtJst, receiptNo, transactionId, cashierName){
      const items = Array.from(state.itemsByCode.values());

      const header = [
        "registered_at_jst",
        "receipt_no",
        "transaction_id",
        "cashier_name",
        "record_type",
        "product_code",
        "product_name",
        "qty",
        "unit_price_excl",
        "line_amount_excl",
        "tax_rate",
        "taxable_amount_excl",
        "tax_amount",
        "taxable_amount_incl"
      ];

      const rows = [];
      rows.push(header);

      // ITEM rows (tax columns empty)
      for (const it of items){
        rows.push([
          registeredAtJst,
          receiptNo,
          transactionId,
          cashierName,
          "ITEM",
          it.product_code,
          it.product_name,
          String(it.qty),
          String(it.unit_price_excl),
          String(it.line_amount_excl),
          String(it.tax_rate),
          "",
          "",
          ""
        ]);
      }

      // TAX_SUMMARY rows
      const s = state.subtotalFresh ? state.subtotal : calcSubtotalSnapshotForCsv(items);

      if (s.excl10 > 0 || s.tax10 > 0 || s.incl10 > 0){
        rows.push([
          registeredAtJst,
          receiptNo,
          transactionId,
          cashierName,
          "TAX_SUMMARY",
          "",
          "",
          "",
          "",
          "",
          "10",
          String(s.excl10),
          String(s.tax10),
          String(s.incl10)
        ]);
      }
      if (s.excl8 > 0 || s.tax8 > 0 || s.incl8 > 0){
        rows.push([
          registeredAtJst,
          receiptNo,
          transactionId,
          cashierName,
          "TAX_SUMMARY",
          "",
          "",
          "",
          "",
          "",
          "8",
          String(s.excl8),
          String(s.tax8),
          String(s.incl8)
        ]);
      }

      // CSVã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
      return rows.map(cols => cols.map(csvEscape).join(",")).join("\n");
    }

    function calcSubtotalSnapshotForCsv(items){
      const excl8 = items.filter(i => i.tax_rate === 8).reduce((a,b)=>a+b.line_amount_excl, 0);
      const excl10 = items.filter(i => i.tax_rate === 10).reduce((a,b)=>a+b.line_amount_excl, 0);
      const tax8 = calcTaxCeil(excl8, 8);
      const tax10 = calcTaxCeil(excl10, 10);
      const incl8 = excl8 + tax8;
      const incl10 = excl10 + tax10;
      const totalIncl = incl8 + incl10;
      return { excl8, tax8, incl8, excl10, tax10, incl10, totalIncl };
    }

    function csvEscape(v){
      const s = String(v ?? "");
      if (/[",\n\r]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
      return s;
    }

    function downloadCsv(filename, text){
      const blob = new Blob([text], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // =========================
    // Register (mock)
    // å®Ÿé‹ç”¨ã§ã¯ã“ã“ã‚’API POSTã«ç½®ãæ›ãˆã‚‹
    // =========================
    async function registerTransaction(){
      const cashierName = (elCashierName.value || "").trim();
      if (!cashierName){
        setRegNotice("warn", "ãƒ¬ã‚¸æ‹…å½“è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      const items = Array.from(state.itemsByCode.values());
      if (items.length === 0){
        setRegNotice("warn", "å•†å“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      const receiptNo = (elReceiptNo.value || "").trim();
      if (!receiptNo){
        setRegNotice("warn", "ãƒ¬ã‚·ãƒ¼ãƒˆç•ªå·ãŒæœªå…¥åŠ›ã§ã™ã€‚å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        elReceiptNo.focus();
        return;
      }

      // å°è¨ˆãŒå¤ã„å ´åˆã¯ç™»éŒ²å‰ã«æ›´æ–°ã—ã¦æƒãˆã‚‹
      if (!state.subtotalFresh){
        runSubtotal();
      }

      const nowJst = getNowJstDate();
      const registeredAtJst = formatJstDateTime(nowJst);
      const ymd = yyyymmddFromJst(nowJst);
      const txId = `${ymd}_${sanitizeReceiptForTx(receiptNo)}`;

      // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãªã‚‰é€ä¿¡å¤±æ•—æ‰±ã„ -> CSVã¸èª˜å°
      const online = navigator.onLine;

      // ã“ã“ã§æœ¬æ¥ã¯ API POST
      // const res = await fetch("/api/transactions", { method:"POST", headers:{...}, body: JSON.stringify(...) })
      // if (!res.ok) throw ...
      if (!online){
        const csv = buildCsvText(registeredAtJst, receiptNo, txId, cashierName);
        elBtnDownloadCsv.hidden = false;
        elBtnDownloadCsv.onclick = () => {
          downloadCsv(`${txId}.csv`, csv);
        };
        setRegNotice("err", "é€ä¿¡ã§ãã¾ã›ã‚“ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ï¼‰ã€‚CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ä¿ç®¡ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      // ãƒ‡ãƒ¢ã¨ã—ã¦ã€ŒæˆåŠŸæ‰±ã„ã€
      elBtnDownloadCsv.hidden = true;
      setRegNotice("ok", `ç™»éŒ²ã—ã¾ã—ãŸï¼ˆãƒ‡ãƒ¢ï¼‰ã€‚transaction_id: ${txId}`);

      // æ¬¡ä¼šè¨ˆã¸
      resetAll(true);
      keepFocus();
    }

    // =========================
    // Scan handling
    // =========================
    function normalizeScanCode(raw){
      // æ•°å­—ä»¥å¤–ã‚’é™¤å»ï¼ˆã‚¹ã‚­ãƒ£ãƒŠã®ä½™è¨ˆãªæ–‡å­—æ··å…¥å¯¾ç­–ï¼‰
      const s = String(raw || "").trim().replace(/[^\d]/g, "");
      return s;
    }

    async function handleScanCommit(raw){
      const cashierName = (elCashierName.value || "").trim();
      if (!cashierName){
        setNotice("warn", "å…ˆã«ãƒ¬ã‚¸æ‹…å½“è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      const code = normalizeScanCode(raw);
      if (!code){
        setNotice("", "ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      if (!/^\d{1,13}$/.test(code)){
        setNotice("err", "å•†å“ã‚³ãƒ¼ãƒ‰ã¯æ•°å­—1ã€œ13æ¡ã®ã¿å¯¾å¿œã§ã™ã€‚");
        return;
      }

      try{
        setNotice("", "å‚ç…§ä¸­...");
        const product = await fetchProductByCode(code);
        if (!product){
          setNotice("err", `å•†å“ãƒã‚¹ã‚¿ã«ã‚ã‚Šã¾ã›ã‚“ï¼š${code}`);
          return;
        }
        upsertItem(product);
        setNotice("ok", `è¿½åŠ ï¼š${product.product_name}ï¼ˆ${product.tax_rate}%ï¼‰`);
      } catch(e){
        setNotice("err", "å•†å“å‚ç…§ã«å¤±æ•—ã—ã¾ã—ãŸã€‚é€šä¿¡çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
      }
    }

    function keepFocus(){
      // iOS Safari ã§ã¯çŠ¶æ³ã«ã‚ˆã£ã¦ focus ãŒåŠ¹ã‹ãªã„ã“ã¨ãŒã‚ã‚‹ã®ã§ try
      try{
        elScanInput.focus();
        elScanInput.select();
      }catch(e){}
    }

    // =========================
    // Reset
    // =========================
    function resetAll(keepCashier){
      state.itemsByCode.clear();
      state.lastAddedText = "---";
      elLastAdded.textContent = state.lastAddedText;

      state.subtotal = { excl8:0, tax8:0, incl8:0, excl10:0, tax10:0, incl10:0, totalIncl:0 };
      state.subtotalFresh = false;
      state.lastSubtotalAtJst = null;

      elExcl8.textContent = "0";
      elTax8.textContent = "0";
      elIncl8.textContent = "0";
      elExcl10.textContent = "0";
      elTax10.textContent = "0";
      elIncl10.textContent = "0";
      elTotalIncl.textContent = "0";

      elReceiptNo.value = "";
      updateTxIdPreview();

      elBtnDownloadCsv.hidden = true;
      setNotice("", "ã‚¹ã‚­ãƒ£ãƒ³æ¬„ã¯å¸¸ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã—ã¦ä½¿ã£ã¦ãã ã•ã„ã€‚å•†å“ãƒã‚¹ã‚¿æœªç™»éŒ²ã¯ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚");
      setRegNotice("", "ç™»éŒ²ã«æˆåŠŸã™ã‚‹ã¨ã€æ˜ç´°ãŒã‚¯ãƒªã‚¢ã•ã‚Œæ¬¡ã®ä¼šè¨ˆã«é€²ã¿ã¾ã™ã€‚é€ä¿¡å¤±æ•—æ™‚ã¯CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚");

      elStaleNotice.hidden = true;
      elCalcState.textContent = "å°è¨ˆæœªå®Ÿè¡Œ";

      renderItems();

      if (!keepCashier){
        elCashierName.value = "";
      }
    }

    // =========================
    // Bind events
    // =========================
    elScanInput.addEventListener("keydown", async (e) => {
      if (e.key === "Enter"){
        e.preventDefault();
        const v = elScanInput.value;
        elScanInput.value = "";
        await handleScanCommit(v);
        keepFocus();
      }
    });

    elBtnAddManual.addEventListener("click", async () => {
      const v = prompt("å•†å“ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ï¼ˆæ•°å­—1ã€œ13æ¡ï¼‰");
      if (v == null) return;
      await handleScanCommit(v);
      keepFocus();
    });

    elBtnFocus.addEventListener("click", () => keepFocus());

    elBtnSubtotal.addEventListener("click", () => {
      runSubtotal();
      keepFocus();
    });

    elBtnRegister.addEventListener("click", async () => {
      await registerTransaction();
      keepFocus();
    });

    elBtnClear.addEventListener("click", () => {
      const ok = confirm("ã“ã®ä¼šè¨ˆã®å†…å®¹ã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ");
      if (!ok) return;
      resetAll(true);
      keepFocus();
    });

    elReceiptNo.addEventListener("input", () => updateTxIdPreview());

    elCashierName.addEventListener("change", () => {
      // æ‹…å½“è€…å¤‰æ›´æ™‚ã¯çŠ¶æ…‹ã‚’æ˜ç¢ºåŒ–
      setRegNotice("", "ãƒ¬ã‚·ãƒ¼ãƒˆç•ªå·å…¥åŠ›å¾Œã€ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚");
      keepFocus();
    });

    // Online/offline events
    window.addEventListener("online", () => { updateNetworkBadge(); });
    window.addEventListener("offline", () => { updateNetworkBadge(); });

    // Clock
    function tick(){
      const j = getNowJstDate();
      elNowJst.textContent = formatJstDateTime(j);
      updateTxIdPreview();
    }

    // Init
    updateNetworkBadge();
    tick();
    setInterval(tick, 1000);
    resetAll(true);
    setTimeout(() => keepFocus(), 200);
  </script>
</body>
</html>
